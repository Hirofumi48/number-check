<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>è»Šä¸¡ç…§åˆã‚·ã‚¹ãƒ†ãƒ ï¼ˆãƒ­ãƒ¼ã‚«ãƒ«CSVå¯¾å¿œç‰ˆï¼‰</title>
    <script src="https://cdn.jsdelivr.net/npm/tesseract.js@4/dist/tesseract.min.js"></script>
    <style>
        body { font-family: sans-serif; text-align: center; background: #f0f0f0; margin: 0; padding-bottom: 50px; }
        #camera-container { position: sticky; top: 0; background: #000; z-index: 10; height: 40vh; overflow: hidden; }
        #video { width: 100%; height: 100%; object-fit: cover; }
        #focus-guide { 
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); 
            width: 75vw; height: 35vw; border: 3px solid #00FF00; border-radius: 12px;
            box-shadow: 0 0 0 5000px rgba(0, 0, 0, 0.5); pointer-events: none;
        }

        #file-upload-section { background: #fff; margin: 10px; padding: 15px; border-radius: 12px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .file-input-label { background: #34c759; color: white; padding: 10px 20px; border-radius: 8px; cursor: pointer; display: inline-block; font-weight: bold; font-size: 14px; }
        #fileInput { display: none; }

        #result-container { margin: 15px; min-height: 160px; padding: 15px; border-radius: 12px; background: white; box-shadow: 0 4px 10px rgba(0,0,0,0.2); text-align: left; }
        #status { font-size: 14px; color: #007AFF; margin-bottom: 10px; font-weight: bold; text-align: center; background: #eef; padding: 5px; border-radius: 4px; }
        
        .info-table { width: 100%; border-collapse: collapse; margin-top: 5px; }
        .info-table th, .info-table td { border: 1px solid #ddd; padding: 10px; font-size: 16px; }
        .info-table th { background-color: #f8f8f8; width: 30%; color: #555; }
        .res-plate-num { font-size: 28px; font-weight: bold; color: #007AFF; }

        .shutter-btn { 
            width: 85px; height: 85px; background: white; border: 6px solid #007AFF; 
            border-radius: 50%; margin: -42px auto 10px; position: relative; z-index: 100;
            display: block; box-shadow: 0 4px 15px rgba(0,0,0,0.3); outline: none;
        }
        .shutter-btn:active { background: #007AFF; }

        #history-area { margin: 15px; text-align: left; }
        .history-label { font-size: 13px; color: #666; font-weight: bold; margin-bottom: 8px; padding-left: 5px; }
        .card { background: white; padding: 12px; border-radius: 8px; margin-bottom: 8px; border-left: 8px solid #ccc; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .card.match { border-left-color: #28a745; }
        .card.alert { border-left-color: #dc3545; background: #fff5f5; }
    </style>
</head>
<body>

    <div id="camera-container">
        <video id="video" autoplay playsinline></video>
        <div id="focus-guide"></div>
    </div>
    
    <button id="shutter" class="shutter-btn"></button>

    <div id="file-upload-section">
        <label class="file-input-label">
            ğŸ“ iPhoneå†…ã®åç°¿(CSV)ã‚’é¸æŠ
            <input type="file" id="fileInput" accept=".csv">
        </label>
        <div id="file-status" style="font-size: 12px; color: #666; margin-top: 5px;">åç°¿ã‚’èª­ã¿è¾¼ã‚“ã§ãã ã•ã„</div>
    </div>

    <div id="result-container">
        <div id="status">åç°¿ã‚’èª­è¾¼å¾Œã€æ ã‚’æ•°å­—ã«åˆã‚ã›ã¦ã‚¿ãƒƒãƒ—</div>
        <div id="info-display" style="display:none;">
            <table class="info-table">
                <tr><th>ãƒŠãƒ³ãƒãƒ¼</th><td id="res-plate" class="res-plate-num"></td></tr>
                <tr><th>ç¤¾å“¡ç•ªå·</th><td id="res-id"></td></tr>
                <tr><th>éƒ¨ç½²</th><td id="res-dept"></td></tr>
                <tr><th>æ°å</th><td id="res-name"></td></tr>
            </table>
        </div>
    </div>

    <div id="history-area">
        <div class="history-label">æ¤œçŸ¥å±¥æ­´ï¼ˆæœ€æ–°10ä»¶ï¼‰</div>
        <div id="history-items"></div>
    </div>

<script>
const video = document.getElementById('video');
const shutter = document.getElementById('shutter');
const statusDiv = document.getElementById('status');
const infoDisplay = document.getElementById('info-display');
const historyItems = document.getElementById('history-items');
const fileInput = document.getElementById('fileInput');
const fileStatus = document.getElementById('file-status');

let employeeList = []; 
let isProcessing = false;

// CSVèª­ã¿è¾¼ã¿ (UTF-8)
fileInput.addEventListener('change', (e) => {
    const file = e.target.files[0];
    if (!file) return;

    const reader = new FileReader();
    reader.onload = (event) => {
        const text = event.target.result;
        const rows = text.split('\n');
        employeeList = [];
        for (let i = 0; i < rows.length; i++) {
            const cols = rows[i].split(',');
            if (cols.length >= 2 && cols[0].trim() !== "") {
                employeeList.push({
                    plate: cols[0].replace(/[^0-9]/g, '').trim(), // ãƒŠãƒ³ãƒãƒ¼
                    id: cols[1] ? cols[1].trim() : "-",
                    dept: cols[2] ? cols[2].trim() : "-",
                    name: cols[3] ? cols[3].trim() : "ä¸æ˜"
                });
            }
        }
        fileStatus.innerText = `èª­ã¿è¾¼ã¿å®Œäº†: ${employeeList.length}ä»¶`;
        statusDiv.innerText = "ç…§åˆã®æº–å‚™ãŒã§ãã¾ã—ãŸ";
    };
    reader.readAsText(file, 'UTF-8'); 
});

async function startCamera() {
    const stream = await navigator.mediaDevices.getUserMedia({ 
        video: { facingMode: "environment", width: { ideal: 1280 } } 
    });
    video.srcObject = stream;
}

function findEmployee(detectedNum) {
    if (!detectedNum || employeeList.length === 0) return null;
    const numOnly = detectedNum.replace(/[^0-9]/g, '');
    const candidates = [numOnly, numOnly.substring(1), numOnly.replace(/^0+/, '')];

    for (const val of candidates) {
        if (!val) continue;
        const match = employeeList.find(emp => emp.plate === val || (val.length === emp.plate.length && isSimilar(val, emp.plate)));
        if (match) return match;
    }
    return null;
}

function isSimilar(s1, s2) {
    let diff = 0;
    for (let i = 0; i < s1.length; i++) { if (s1[i] !== s2[i]) diff++; }
    return diff <= 1;
}

async function processFrame() {
    const canvas = document.createElement('canvas');
    const ctx = canvas.getContext('2d');
    const vW = video.videoWidth;
    const vH = video.videoHeight;
    const frameW = vW * 0.8; 
    const frameH = vW * 0.4;
    canvas.width = 800; canvas.height = 400;
    ctx.filter = "contrast(180%) grayscale(100%) brightness(95%)";
    ctx.drawImage(video, (vW-frameW)/2, (vH-frameH)/2, frameW, frameH, 0, 0, 800, 400);
    const result = await Tesseract.recognize(canvas, 'eng', { tessedit_char_whitelist: '0123456789', tessedit_pageseg_mode: '8' });
    return result.data.text.replace(/[^0-9]/g, '');
}

async function takePhoto() {
    if (isProcessing) return;
    if (employeeList.length === 0) {
        alert("åç°¿CSVã‚’é¸æŠã—ã¦ãã ã•ã„");
        return;
    }
    isProcessing = true;
    statusDiv.innerText = "è§£æä¸­ (3é€£å°„)...";
    
    let finalMatch = null;
    let lastNum = "";

    for (let i = 0; i < 3; i++) {
        statusDiv.innerText = `è§£æä¸­ (${i+1}/3æšç›®)...`;
        const num = await processFrame();
        lastNum = num;
        finalMatch = findEmployee(num);
        if (finalMatch) break;
        await new Promise(r => setTimeout(r, 150));
    }

    if (finalMatch) {
        displayResult(finalMatch.plate, finalMatch, "match");
    } else {
        displayResult(lastNum || "??", { id: "-", dept: "-", name: "æœªç™»éŒ²" }, "alert");
    }
    isProcessing = false;
}

function displayResult(plate, data, type) {
    infoDisplay.style.display = "block";
    document.getElementById('res-plate').innerText = plate;
    document.getElementById('res-id').innerText = data.id;
    document.getElementById('res-dept').innerText = data.dept;
    document.getElementById('res-name').innerText = data.name;
    statusDiv.innerText = type === "match" ? "ç…§åˆä¸€è‡´" : "æœªç™»éŒ²";
    addHistory(plate, data, type);
    speak(data.name);
}

function addHistory(num, data, type) {
    const card = document.createElement('div');
    card.className = `card ${type}`;
    card.innerHTML = `
        <div><b>${num}</b> : ${data.name} <small>(${data.dept})</small></div>
        <div style="font-size:11px; color:#999;">${new Date().toLocaleTimeString()}</div>
    `;
    historyItems.prepend(card);
    if (historyItems.children.length > 10) historyItems.lastChild.remove();
}

function speak(t) {
    const s = new SpeechSynthesisUtterance(t);
    s.lang = 'ja-JP';
    speechSynthesis.speak(s);
}

shutter.onclick = takePhoto;
window.onload = startCamera;
</script>
</body>
</html>

<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>è»Šä¸¡ç…§åˆï¼ˆåº§æ¨™ãƒ™ãƒ¼ã‚¹èªè­˜ï¼‰</title>
    <script src="https://cdn.jsdelivr.net/npm/tesseract.js@4/dist/tesseract.min.js"></script>
    <style>
        body { font-family: sans-serif; text-align: center; background: #f0f0f0; margin: 0; padding-bottom: 50px; overflow-x: hidden; }
        #camera-container { position: sticky; top: 0; background: #000; z-index: 10; height: 45vh; display: flex; align-items: center; justify-content: center; overflow: hidden; }
        #video { width: 100%; height: 100%; object-fit: cover; }
        
        /* 330:165 (2:1) ã®æ¯”ç‡ã«å›ºå®šã—ãŸã‚¬ã‚¤ãƒ‰æ  */
        #focus-guide { 
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); 
            width: 80vw; height: 40vw; /* 2:1æ¯”ç‡ */
            border: 3px solid #00FF00; border-radius: 4px;
            box-shadow: 0 0 0 5000px rgba(0, 0, 0, 0.6); pointer-events: none;
        }
        #guide-label { position: absolute; top: -25px; left: 0; color: #00FF00; font-size: 12px; font-weight: bold; }

        #action-area { display: flex; justify-content: center; align-items: center; gap: 20px; margin: -30px auto 10px; position: relative; z-index: 100; }
        .shutter-btn { width: 70px; height: 70px; background: white; border: 5px solid #007AFF; border-radius: 50%; box-shadow: 0 4px 15px rgba(0,0,0,0.3); }
        .manual-btn { background: #555; color: white; border: none; padding: 10px 15px; border-radius: 20px; font-size: 14px; }

        #manual-input-panel { display: none; background: white; margin: 10px 15px; padding: 15px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.2); }
        #manual-num-input { width: 60%; font-size: 24px; padding: 10px; border: 2px solid #ddd; border-radius: 8px; text-align: center; }

        #file-upload-section { background: #fff; margin: 10px; padding: 10px; border-radius: 12px; }
        .file-input-label { background: #34c759; color: white; padding: 8px 16px; border-radius: 8px; cursor: pointer; font-size: 13px; font-weight: bold; }
        
        #result-container { margin: 10px 15px; padding: 15px; border-radius: 12px; background: white; box-shadow: 0 4px 10px rgba(0,0,0,0.2); text-align: left; }
        #status { font-size: 14px; color: #007AFF; margin-bottom: 10px; font-weight: bold; text-align: center; background: #eef; padding: 5px; border-radius: 4px; }
        
        .info-table { width: 100%; border-collapse: collapse; }
        .info-table th, .info-table td { border: 1px solid #ddd; padding: 8px; }
        .info-table th { background-color: #f8f8f8; width: 30%; font-size: 14px; }
        .res-plate-num { font-size: 28px; font-weight: bold; color: #007AFF; letter-spacing: 2px; }

        #debug-canvas-container { margin: 10px; font-size: 11px; color: #666; }
        canvas { max-width: 100%; height: auto; border: 1px solid #ccc; margin-top: 5px; }
        
        .card { background: white; padding: 10px; border-radius: 8px; margin-bottom: 5px; border-left: 6px solid #ccc; display: flex; justify-content: space-between; align-items: center; font-size: 14px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        .card.match { border-left-color: #28a745; }
        .card.alert { border-left-color: #dc3545; }
    </style>
</head>
<body>

    <div id="camera-container">
        <video id="video" autoplay playsinline></video>
        <div id="focus-guide">
            <div id="guide-label">æ å†…ã«ãƒŠãƒ³ãƒãƒ¼ã‚’åˆã‚ã›ã¦ãã ã•ã„</div>
        </div>
    </div>
    
    <div id="action-area">
        <button id="shutter" class="shutter-btn"></button>
        <button id="manualInputBtn" class="manual-btn">âŒ¨ æ‰‹å…¥åŠ›</button>
    </div>

    <div id="manual-input-panel">
        <input type="text" id="manual-num-input" inputmode="numeric" placeholder="æ•°å­—4æ¡">
        <br><br>
        <button style="background:#007AFF; color:white; border:none; padding:10px 20px; border-radius:8px;" id="execManual">ç…§åˆ</button>
        <button style="background:none; border:none; color:gray; margin-left:10px;" id="cancelManual">é–‰ã˜ã‚‹</button>
    </div>

    <div id="file-upload-section">
        <label class="file-input-label">ğŸ“ åç°¿CSVã‚’é¸æŠ<input type="file" id="fileInput" accept=".csv" style="display:none;"></label>
        <div id="file-status" style="font-size: 11px; margin-top:5px;">åç°¿ã‚’èª­è¾¼å¾Œã«é–‹å§‹</div>
    </div>

    <div id="result-container">
        <div id="status">Ready</div>
        <div id="info-display"></div>
    </div>

    <div id="debug-canvas-container">
        è§£æã‚¨ãƒªã‚¢ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼:<br>
        <canvas id="debugCanvas"></canvas>
    </div>

    <div id="history-area" style="margin:15px; text-align:left;">
        <div style="font-size:12px; color:#666; margin-bottom:5px;">å±¥æ­´</div>
        <div id="history-items"></div>
    </div>

<script>
const video = document.getElementById('video');
const shutter = document.getElementById('shutter');
const statusDiv = document.getElementById('status');
const infoDisplay = document.getElementById('info-display');
const debugCanvas = document.getElementById('debugCanvas');
const historyItems = document.getElementById('history-items');
const fileInput = document.getElementById('fileInput');

let employeeList = []; 
let isProcessing = false;

// éŸ³å£°ã‚¢ãƒ³ãƒ­ãƒƒã‚¯
function unlockAudio() {
    window.speechSynthesis.cancel();
    window.speechSynthesis.speak(new SpeechSynthesisUtterance(" "));
}
document.addEventListener('touchstart', unlockAudio, { once: true });

// CSVèª­è¾¼
fileInput.addEventListener('change', (e) => {
    const file = e.target.files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = (event) => {
        const rows = event.target.result.split('\n');
        employeeList = rows.map(row => {
            const cols = row.split(',');
            return {
                plate: (cols[0]||"").replace(/[^0-9]/g, '').trim(),
                id: (cols[1]||"").trim(),
                dept: (cols[2]||"").trim(),
                name: (cols[3]||"").trim()
            };
        }).filter(item => item.plate !== "");
        document.getElementById('file-status').innerText = `èª­è¾¼å®Œäº†: ${employeeList.length}ä»¶`;
        statusDiv.innerText = "æº–å‚™å®Œäº†";
    };
    reader.readAsText(file, 'UTF-8'); 
});

async function startCamera() {
    const stream = await navigator.mediaDevices.getUserMedia({ 
        video: { facingMode: "environment", width: { ideal: 1920 }, height: { ideal: 1080 } } 
    });
    video.srcObject = stream;
}

// ç…§åˆãƒ­ã‚¸ãƒƒã‚¯
function findAllMatches(num) {
    if (!num || num.length > 4) return [];
    // å®Œå…¨ä¸€è‡´
    let found = employeeList.filter(e => e.plate === num);
    if (found.length > 0) return found;
    // 0åŸ‹ã‚è€ƒæ…® (ä¾‹: "1" ã¨èª­ã‚ãŸã¨ã "0001" ã‚’æ¢ã™)
    if (num.length < 4) {
        const zeroFilled = num.padStart(4, '0');
        found = employeeList.filter(e => e.plate === zeroFilled || e.plate === num.replace(/^0+/, ''));
        if (found.length > 0) return found;
    }
    return [];
}

async function takePhoto() {
    if (isProcessing || employeeList.length === 0) return;
    isProcessing = true;
    statusDiv.innerText = "è§£æä¸­...";

    const canvas = document.createElement('canvas');
    const vW = video.videoWidth;
    const vH = video.videoHeight;
    
    // ã‚¬ã‚¤ãƒ‰æ ã®åº§æ¨™è¨ˆç®—ï¼ˆä¸­å¤®ã®2:1ã®ç¯„å›²ï¼‰
    const guideW = vW * 0.8;
    const guideH = guideW * (165/330);
    const startX = (vW - guideW) / 2;
    const startY = (vH - guideH) / 2;

    // --- åº§æ¨™ãƒ™ãƒ¼ã‚¹åˆ‡ã‚ŠæŠœããƒ­ã‚¸ãƒƒã‚¯ ---
    // ãƒŠãƒ³ãƒãƒ¼ãƒ—ãƒ¬ãƒ¼ãƒˆã®æ¨ª330:ç¸¦165ã«å¯¾ã—ã€å¤§ããªæ•°å­—4æ¡ã‚¨ãƒªã‚¢ã¯ãŠãŠã‚ˆã
    // æ¨ª: 70/330(21%) ã€œ 315/330(95%)
    // ç¸¦: 65/165(39%) ã€œ 155/165(94%)
    const cropX = startX + (guideW * (70 / 330));
    const cropY = startY + (guideH * (65 / 165));
    const cropW = guideW * (245 / 330);
    const cropH = guideH * (90 / 165);

    canvas.width = 600; // OCRç”¨ã«ãƒªã‚µã‚¤ã‚º
    canvas.height = canvas.width * (cropH / cropW);
    const ctx = canvas.getContext('2d');
    
    // é®®æ˜åŒ–å‡¦ç†
    ctx.filter = "contrast(150%) grayscale(100%)";
    ctx.drawImage(video, cropX, cropY, cropW, cropH, 0, 0, canvas.width, canvas.height);
    
    // ãƒ‡ãƒãƒƒã‚°è¡¨ç¤º
    debugCanvas.width = canvas.width;
    debugCanvas.height = canvas.height;
    debugCanvas.getContext('2d').drawImage(canvas, 0, 0);

    const result = await Tesseract.recognize(canvas, 'eng', { 
        tessedit_char_whitelist: '0123456789',
        tessedit_pageseg_mode: '7' // 1è¡Œã¨ã—ã¦èªè­˜
    });

    const detected = result.data.text.replace(/[^0-9]/g, '');
    const matches = findAllMatches(detected);

    if (matches.length > 0) {
        showResult(detected, matches, "match");
    } else if (detected.length > 4 || detected === "") {
        showResult(detected || "----", [], "error");
    } else {
        showResult(detected, [], "alert");
    }

    isProcessing = false;
}

function showResult(num, dataArray, type) {
    infoDisplay.innerHTML = "";
    if (type === "match") {
        statusDiv.innerText = "ç…§åˆä¸€è‡´";
        statusDiv.style.backgroundColor = "#eef";
        dataArray.forEach(data => {
            infoDisplay.innerHTML += `
                <table class="info-table">
                    <tr><th>ãƒŠãƒ³ãƒãƒ¼</th><td class="res-plate-num">${num}</td></tr>
                    <tr><th>æ°å</th><td>${data.name}</td></tr>
                    <tr><th>éƒ¨ç½²</th><td>${data.dept}</td></tr>
                </table>`;
            speak(data.name + "ã•ã‚“");
            addHistory(num, data.name, "match");
        });
    } else if (type === "error") {
        statusDiv.innerText = "èª­ã¿å–ã‚Šå¤±æ•—";
        infoDisplay.innerHTML = "æ ã«åˆã‚ã›ã¦å†æ’®å½±ã—ã¦ãã ã•ã„";
        speak("ã‚‚ã†ä¸€åº¦ãŠé¡˜ã„ã—ã¾ã™");
    } else {
        statusDiv.innerText = "æœªç™»éŒ²";
        infoDisplay.innerHTML = `<table class="info-table"><tr><th>ãƒŠãƒ³ãƒãƒ¼</th><td class="res-plate-num">${num}</td></tr><tr><th>æ°å</th><td>æœªç™»éŒ²</td></tr></table>`;
        speak("æœªç™»éŒ²ã§ã™");
        addHistory(num, "æœªç™»éŒ²", "alert");
    }
}

function addHistory(num, name, type) {
    const card = document.createElement('div');
    card.className = `card ${type}`;
    card.innerHTML = `<div><b>${num}</b> : ${name}</div><div style="font-size:10px; color:#999;">${new Date().toLocaleTimeString()}</div>`;
    historyItems.prepend(card);
}

function speak(t) {
    window.speechSynthesis.cancel();
    const s = new SpeechSynthesisUtterance(t);
    s.lang = 'ja-JP';
    window.speechSynthesis.speak(s);
}

document.getElementById('execManual').onclick = () => {
    const val = document.getElementById('manual-num-input').value;
    const m = findAllMatches(val);
    showResult(val, m, m.length > 0 ? "match" : "alert");
    document.getElementById('manual-input-panel').style.display = "none";
};
document.getElementById('manualInputBtn').onclick = () => { document.getElementById('manual-input-panel').style.display = "block"; };
document.getElementById('cancelManual').onclick = () => { document.getElementById('manual-input-panel').style.display = "none"; };
shutter.onclick = takePhoto;
window.onload = startCamera;
</script>
</body>
</html>

<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>è»Šä¸¡ç…§åˆï¼ˆ4åˆ†å‰²å€‹åˆ¥èªè­˜ç‰ˆï¼‰</title>
    <script src="https://cdn.jsdelivr.net/npm/tesseract.js@4/dist/tesseract.min.js"></script>
    <style>
        body { font-family: sans-serif; text-align: center; background: #f0f0f0; margin: 0; padding-bottom: 50px; }
        #camera-container { position: sticky; top: 0; background: #000; z-index: 10; height: 40vh; display: flex; align-items: center; justify-content: center; overflow: hidden; }
        #video { width: 100%; height: 100%; object-fit: cover; }
        #focus-guide { 
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); 
            width: 80vw; height: 40vw; border: 3px solid #00FF00; border-radius: 4px;
            box-shadow: 0 0 0 5000px rgba(0, 0, 0, 0.6); pointer-events: none;
        }
        #action-area { display: flex; justify-content: center; gap: 20px; margin: -35px auto 10px; position: relative; z-index: 100; }
        .shutter-btn { width: 70px; height: 70px; background: white; border: 5px solid #007AFF; border-radius: 50%; }
        #result-container { margin: 10px 15px; padding: 15px; border-radius: 12px; background: white; box-shadow: 0 4px 10px rgba(0,0,0,0.2); text-align: left; }
        #status { font-size: 14px; color: #007AFF; font-weight: bold; text-align: center; background: #eef; padding: 5px; border-radius: 4px; }
        .res-plate-num { font-size: 32px; font-weight: bold; color: #007AFF; text-align: center; display: block; }
        #debug-area { background: #eee; padding: 5px; margin: 10px; font-size: 10px; }
        .debug-canvas { border: 1px solid #333; margin: 2px; width: 45px; height: auto; }
    </style>
</head>
<body>

<div id="camera-container">
    <video id="video" autoplay playsinline></video>
    <div id="focus-guide"></div>
</div>

<div id="action-area">
    <button id="shutter" class="shutter-btn"></button>
</div>

<div style="margin: 10px;">
    <input type="file" id="fileInput" accept=".csv" style="display:none;">
    <button onclick="document.getElementById('fileInput').click()" style="padding:8px; background:#34c759; color:white; border:none; border-radius:5px;">ğŸ“ åç°¿CSVèª­è¾¼</button>
    <span id="file-status" style="font-size:12px;">åç°¿æœªèª­è¾¼</span>
</div>

<div id="result-container">
    <div id="status">Ready</div>
    <div id="info-display"></div>
</div>

<div id="debug-area">
    4æ–‡å­—å€‹åˆ¥æŠ½å‡ºãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼:<br>
    <div id="canvas-holder"></div>
</div>

<script>
const video = document.getElementById('video');
const shutter = document.getElementById('shutter');
const statusDiv = document.getElementById('status');
const infoDisplay = document.getElementById('info-display');
const fileInput = document.getElementById('fileInput');
const canvasHolder = document.getElementById('canvas-holder');

let employeeList = [];
let isProcessing = false;

// Tesseractã®åˆæœŸè¨­å®šï¼ˆæ•°å­—1æ–‡å­—èªè­˜ãƒ¢ãƒ¼ãƒ‰ã‚’å„ªå…ˆï¼‰
async function recognizeChar(canvas) {
    const result = await Tesseract.recognize(canvas, 'eng', {
        tessedit_char_whitelist: '0123456789',
        tessedit_pageseg_mode: '10' // 1æ–‡å­—ã¨ã—ã¦èªè­˜
    });
    return result.data.text.replace(/[^0-9]/g, '').trim();
}

fileInput.onchange = (e) => {
    const reader = new FileReader();
    reader.onload = (ev) => {
        employeeList = ev.target.result.split('\n').map(r => {
            const c = r.split(',');
            return { plate: (c[0]||"").replace(/[^0-9]/g, '').trim(), name: (c[3]||"ä¸æ˜").trim() };
        }).filter(e => e.plate !== "");
        document.getElementById('file-status').innerText = `èª­è¾¼æ¸ˆ: ${employeeList.length}ä»¶`;
    };
    reader.readAsText(e.target.files[0], 'UTF-8');
};

async function startCamera() {
    const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment", width: 1280 } });
    video.srcObject = stream;
}

shutter.onclick = async () => {
    if (isProcessing || employeeList.length === 0) return;
    isProcessing = true;
    statusDiv.innerText = "1æ–‡å­—ãšã¤ç²¾å¯†è§£æä¸­...";
    canvasHolder.innerHTML = "";

    const vW = video.videoWidth;
    const vH = video.videoHeight;
    const guideW = vW * 0.8;
    const guideH = guideW * 0.5;
    const startX = (vW - guideW) / 2;
    const startY = (vH - guideH) / 2;

    // èŠ³å²¡ã•ã‚“ã®åº§æ¨™ãƒ‡ãƒ¼ã‚¿ã«åŸºã¥ã4åœ°ç‚¹ï¼ˆæ­£è¦åŒ–ï¼‰
    const charCoords = [
        { x: 75, y: 70, w: 40, h: 80 },  // 1æ–‡å­—ç›®
        { x: 130, y: 70, w: 40, h: 80 }, // 2æ–‡å­—ç›®
        { x: 215, y: 70, w: 40, h: 80 }, // 3æ–‡å­—ç›®
        { x: 270, y: 70, w: 40, h: 80 }  // 4æ–‡å­—ç›®
    ];

    let finalNum = "";

    for (const coord of charCoords) {
        const c = document.createElement('canvas');
        c.width = 80; c.height = 160;
        const ctx = c.getContext('2d');
        
        const realX = startX + (guideW * (coord.x / 330));
        const realY = startY + (guideH * (coord.y / 165));
        const realW = guideW * (coord.w / 330);
        const realH = guideH * (coord.h / 165);

        ctx.filter = "contrast(180%) grayscale(100%) brightness(90%)";
        ctx.drawImage(video, realX, realY, realW, realH, 0, 0, 80, 160);
        
        c.className = "debug-canvas";
        canvasHolder.appendChild(c);

        const char = await recognizeChar(c);
        finalNum += char; 
    }

    const matches = employeeList.filter(e => e.plate === finalNum);
    
    if (matches.length > 0) {
        statusDiv.innerText = "ç…§åˆä¸€è‡´";
        infoDisplay.innerHTML = `<span class="res-plate-num">${finalNum}</span><div style="text-align:center;">${matches[0].name}ã•ã‚“</div>`;
        speak(matches[0].name + "ã•ã‚“");
    } else {
        statusDiv.innerText = "æœªç™»éŒ²ã¾ãŸã¯å¤±æ•—";
        infoDisplay.innerHTML = `<span class="res-plate-num">${finalNum || "----"}</span>`;
        speak(finalNum ? "æœªç™»éŒ²ã§ã™" : "èª­ã¿å–ã‚Œã¾ã›ã‚“ã§ã—ãŸ");
    }
    
    isProcessing = false;
};

function speak(t) {
    window.speechSynthesis.cancel();
    window.speechSynthesis.speak(new SpeechSynthesisUtterance(t));
}

window.onload = startCamera;
</script>
</body>
</html>

<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>è»Šä¸¡ç…§åˆï¼ˆç…§åˆãƒ­ã‚¸ãƒƒã‚¯ä¿®æ­£ç‰ˆï¼‰</title>
    <script src="https://cdn.jsdelivr.net/npm/tesseract.js@4/dist/tesseract.min.js"></script>
    <style>
        body { font-family: sans-serif; text-align: center; background: #f0f0f0; margin: 0; padding-bottom: 50px; }
        #camera-container { position: sticky; top: 0; background: #000; z-index: 10; height: 35vh; overflow: hidden; }
        #video { width: 100%; height: 100%; object-fit: cover; }
        #focus-guide { 
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); 
            width: 70vw; height: 30vw; border: 3px solid #00FF00; border-radius: 12px;
            box-shadow: 0 0 0 5000px rgba(0, 0, 0, 0.5); pointer-events: none;
        }

        #action-area { display: flex; justify-content: center; align-items: center; gap: 20px; margin: -40px auto 10px; position: relative; z-index: 100; }
        .shutter-btn { 
            width: 80px; height: 80px; background: white; border: 6px solid #007AFF; 
            border-radius: 50%; box-shadow: 0 4px 15px rgba(0,0,0,0.3); outline: none;
        }
        .shutter-btn:active { background: #007AFF; }
        .manual-btn {
            background: #555; color: white; border: none; padding: 10px 15px; border-radius: 20px;
            font-size: 14px; font-weight: bold; box-shadow: 0 4px 10px rgba(0,0,0,0.2);
        }

        #manual-input-panel {
            display: none; background: white; margin: 10px 15px; padding: 15px; border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2); text-align: center;
        }
        #manual-num-input {
            width: 60%; font-size: 24px; padding: 10px; border: 2px solid #ddd; border-radius: 8px;
            text-align: center; margin-bottom: 10px; -webkit-appearance: none;
        }
        .input-ok-btn { background: #007AFF; color: white; border: none; padding: 12px 25px; border-radius: 8px; font-weight: bold; }

        #file-upload-section { background: #fff; margin: 10px; padding: 12px; border-radius: 12px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .file-input-label { background: #34c759; color: white; padding: 8px 16px; border-radius: 8px; cursor: pointer; display: inline-block; font-weight: bold; font-size: 13px; }
        #fileInput { display: none; }

        #result-container { margin: 10px 15px; min-height: 100px; padding: 15px; border-radius: 12px; background: white; box-shadow: 0 4px 10px rgba(0,0,0,0.2); text-align: left; }
        #status { font-size: 14px; color: #007AFF; margin-bottom: 10px; font-weight: bold; text-align: center; background: #eef; padding: 5px; border-radius: 4px; }
        
        .match-group { border-bottom: 2px dashed #eee; padding-bottom: 10px; margin-bottom: 10px; }
        .info-table { width: 100%; border-collapse: collapse; margin-top: 5px; }
        .info-table th, .info-table td { border: 1px solid #ddd; padding: 8px; font-size: 15px; }
        .info-table th { background-color: #f8f8f8; width: 30%; color: #555; }
        .res-plate-num { font-size: 24px; font-weight: bold; color: #007AFF; }
        .multi-tag { background: orange; color: white; font-size: 10px; padding: 2px 6px; border-radius: 10px; vertical-align: middle; margin-left: 5px; }

        #history-area { margin: 15px; text-align: left; }
        .history-label { font-size: 13px; color: #666; font-weight: bold; margin-bottom: 8px; padding-left: 5px; }
        .card { background: white; padding: 12px; border-radius: 8px; margin-bottom: 8px; border-left: 8px solid #ccc; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .card.match { border-left-color: #28a745; }
        .card.alert { border-left-color: #dc3545; background: #fff5f5; }
        .card.error { border-left-color: #ffc107; background: #fffdf5; }
    </style>
</head>
<body>

    <div id="camera-container">
        <video id="video" autoplay playsinline></video>
        <div id="focus-guide"></div>
    </div>
    
    <div id="action-area">
        <button id="shutter" class="shutter-btn"></button>
        <button id="manualInputBtn" class="manual-btn">âŒ¨ æ‰‹å…¥åŠ›</button>
    </div>

    <div id="manual-input-panel">
        <input type="text" id="manual-num-input" inputmode="numeric" pattern="[0-9]*" placeholder="æ•°å­—4æ¡">
        <br>
        <button class="input-ok-btn" id="execManual">ç…§åˆã™ã‚‹</button>
        <button style="background:none; border:none; color:gray; margin-left:10px;" id="cancelManual">é–‰ã˜ã‚‹</button>
    </div>

    <div id="file-upload-section">
        <label class="file-input-label">
            ğŸ“ åç°¿(CSV)é¸æŠ
            <input type="file" id="fileInput" accept=".csv">
        </label>
        <div id="file-status" style="font-size: 11px; color: #666; margin-top: 5px;">åç°¿ã‚’èª­ã¿è¾¼ã‚“ã§ãã ã•ã„</div>
    </div>

    <div id="result-container">
        <div id="status">åç°¿ã‚’èª­è¾¼å¾Œã€é–‹å§‹ã—ã¦ãã ã•ã„</div>
        <div id="info-display"></div>
    </div>

    <div id="history-area">
        <div class="history-label">æ¤œçŸ¥å±¥æ­´ï¼ˆæœ€æ–°10ä»¶ï¼‰</div>
        <div id="history-items"></div>
    </div>

<script>
const video = document.getElementById('video');
const shutter = document.getElementById('shutter');
const manualBtn = document.getElementById('manualInputBtn');
const manualPanel = document.getElementById('manual-input-panel');
const manualInputField = document.getElementById('manual-num-input');
const execManualBtn = document.getElementById('execManual');
const cancelManualBtn = document.getElementById('cancelManual');
const statusDiv = document.getElementById('status');
const infoDisplay = document.getElementById('info-display');
const historyItems = document.getElementById('history-items');
const fileInput = document.getElementById('fileInput');

let employeeList = []; 
let isProcessing = false;

function unlockAudio() {
    window.speechSynthesis.cancel();
    const s = new SpeechSynthesisUtterance(" ");
    s.volume = 0;
    window.speechSynthesis.speak(s);
}

document.addEventListener('touchstart', unlockAudio, { once: true });

fileInput.addEventListener('change', (e) => {
    const file = e.target.files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = (event) => {
        const rows = event.target.result.split('\n');
        employeeList = [];
        for (let i = 0; i < rows.length; i++) {
            const cols = rows[i].split(',');
            if (cols.length >= 2 && cols[0].trim() !== "") {
                // ãƒŠãƒ³ãƒãƒ¼åˆ—ã‹ã‚‰æ•°å­—ã ã‘ã‚’æŠ½å‡º
                const plateNum = cols[0].replace(/[^0-9]/g, '').trim();
                if (plateNum) {
                    employeeList.push({
                        plate: plateNum, 
                        id: cols[1] ? cols[1].trim() : "-",
                        dept: cols[2] ? cols[2].trim() : "-",
                        name: cols[3] ? cols[3].trim() : "ä¸æ˜"
                    });
                }
            }
        }
        document.getElementById('file-status').innerText = `èª­è¾¼å®Œäº†: ${employeeList.length}ä»¶`;
        statusDiv.innerText = "æº–å‚™å®Œäº†";
        unlockAudio();
    };
    reader.readAsText(file, 'UTF-8'); 
});

async function startCamera() {
    if (video.srcObject) { video.srcObject.getTracks().forEach(track => track.stop()); }
    const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment", width: { ideal: 1280 } } });
    video.srcObject = stream;
    video.play();
}

manualBtn.onclick = () => {
    unlockAudio();
    manualPanel.style.display = "block";
    manualInputField.value = "";
    manualInputField.focus();
};

cancelManualBtn.onclick = () => { manualPanel.style.display = "none"; };

execManualBtn.onclick = async () => {
    const num = manualInputField.value;
    if (!num) return;
    manualPanel.style.display = "none";
    const matches = findAllMatches(num);
    if (matches.length > 0) {
        displayResults(num, matches, "match");
    } else {
        displayResults(num, [{ id: "-", dept: "-", name: "æœªç™»éŒ²" }], "alert");
    }
};

// --- ã“ã“ãŒä¿®æ­£ã®æ ¸å¿ƒï¼šç…§åˆãƒ­ã‚¸ãƒƒã‚¯ ---
function findAllMatches(detectedNum) {
    if (!detectedNum || employeeList.length === 0) return [];
    const numOnly = detectedNum.replace(/[^0-9]/g, '');
    if (!numOnly) return [];

    // 1. ã¾ãšã¯ã€Œå®Œå…¨ä¸€è‡´ã€ã‚’æœ€å„ªå…ˆã§æ¢ã™
    let found = employeeList.filter(emp => emp.plate === numOnly);
    if (found.length > 0) return found;

    // 2. 4æ¡æœªæº€ã®å ´åˆã€OCRã®èª¤èªï¼ˆå…ˆé ­ã®0ãŒèª­ã‚ãªã„ç­‰ï¼‰ã‚’è€ƒæ…®ã—ã¦0ã‚’é™¤å»ã—ã¦å†æ¤œç´¢
    // â€»å…¥åŠ›ãŒ4æ¡ã‚ã‚‹ã¨ãã¯ã€åˆ¥ã®3æ¡è»Šã¨èª¤èªã•ã›ãªã„ãŸã‚å®Ÿè¡Œã—ãªã„
    if (numOnly.length < 4) {
        const noZero = numOnly.replace(/^0+/, '');
        if (noZero && noZero !== numOnly) {
            found = employeeList.filter(emp => emp.plate === noZero);
            if (found.length > 0) return found;
        }
    }

    // 3. æœ€å¾Œã«ã€Œã‚ã„ã¾ã„æ¤œç´¢ï¼ˆ1æ–‡å­—é•ã„ï¼‰ã€
    // èª¤èªè­˜ãƒªã‚¹ã‚¯ã‚’ä¸‹ã’ã‚‹ãŸã‚ã€Œå…¥åŠ›ã¨åç°¿ãŒåŒã˜æ¡æ•°ã€ã‹ã¤ã€Œ3æ¡ä»¥ä¸Šã€ã®å ´åˆã®ã¿å®Ÿè¡Œ
    found = employeeList.filter(emp => 
        numOnly.length >= 3 && 
        emp.plate.length === numOnly.length && 
        isSimilar(numOnly, emp.plate)
    );

    return found;
}

function isSimilar(s1, s2) {
    let diff = 0;
    for (let i = 0; i < s1.length; i++) { if (s1[i] !== s2[i]) diff++; }
    return diff <= 1;
}

async function processFrame() {
    const canvas = document.createElement('canvas');
    const ctx = canvas.getContext('2d');
    const vW = video.videoWidth; const vH = video.videoHeight;
    const frameW = vW * 0.8; const frameH = vW * 0.4;
    canvas.width = 800; canvas.height = 400;
    ctx.filter = "contrast(180%) grayscale(100%) brightness(95%)";
    ctx.drawImage(video, (vW-frameW)/2, (vH-frameH)/2, frameW, frameH, 0, 0, 800, 400);
    const result = await Tesseract.recognize(canvas, 'eng', { tessedit_char_whitelist: '0123456789', tessedit_pageseg_mode: '8' });
    return result.data.text.replace(/[^0-9]/g, '');
}

async function takePhoto() {
    if (isProcessing) return;
    unlockAudio();
    if (employeeList.length === 0) return alert("åç°¿CSVã‚’é¸æŠã—ã¦ãã ã•ã„");
    isProcessing = true;
    statusDiv.innerText = "è§£æä¸­...";
    statusDiv.style.color = "#007AFF"; statusDiv.style.backgroundColor = "#eef";
    
    let finalMatches = [];
    let lastNum = "";
    for (let i = 0; i < 3; i++) {
        const num = await processFrame();
        lastNum = num;
        finalMatches = findAllMatches(num);
        if (finalMatches.length > 0) break;
        await new Promise(r => setTimeout(r, 150));
    }

    if (finalMatches.length > 0) {
        displayResults(finalMatches[0].plate, finalMatches, "match");
    } else if (lastNum === "") {
        displayResults("----", [{ id: "-", dept: "-", name: "(èª­ã¿å–ã‚Šä¸èƒ½)" }], "error");
    } else {
        displayResults(lastNum, [{ id: "-", dept: "-", name: "æœªç™»éŒ²" }], "alert");
    }
    isProcessing = false;
}

function displayResults(plate, dataArray, type) {
    infoDisplay.innerHTML = ""; 
    
    if (type === "match") {
        statusDiv.innerText = dataArray.length > 1 ? `ç…§åˆä¸€è‡´ (${dataArray.length}ä»¶)` : "ç…§åˆä¸€è‡´";
        statusDiv.style.color = "#007AFF"; statusDiv.style.backgroundColor = "#eef";
        let names = [];
        dataArray.forEach((data, index) => {
            const group = document.createElement('div');
            group.className = "match-group";
            group.innerHTML = `<table class="info-table"><tr><th>ãƒŠãƒ³ãƒãƒ¼</th><td class="res-plate-num">${plate}${index===0 && dataArray.length>1 ? '<span class="multi-tag">é‡è¤‡</span>':''}</td></tr><tr><th>æ°å</th><td>${data.name}</td></tr></table>`;
            infoDisplay.appendChild(group);
            names.push(data.name);
        });
        addHistory(plate, dataArray[0], "match", dataArray.length > 1);
        speak(dataArray.length > 1 ? `è©²å½“è€…ãŒ${dataArray.length}åã„ã¾ã™ã€‚${names.join('ã•ã‚“ã¨ã€')}ã•ã‚“ã§ã™ã€‚` : names[0] + "ã•ã‚“");

    } else if (type === "error") {
        statusDiv.innerText = "èª­ã¿å–ã‚Šå¤±æ•—";
        statusDiv.style.color = "#856404"; statusDiv.style.backgroundColor = "#fff3cd";
        infoDisplay.innerHTML = `<table class="info-table"><tr><th>ãƒŠãƒ³ãƒãƒ¼</th><td class="res-plate-num">----</td></tr><tr><th>æ°å</th><td>èª­ã¿å–ã‚Œã¾ã›ã‚“ã§ã—ãŸ</td></tr></table>`;
        addHistory("----", { name: "èª­ã¿å–ã‚Šä¸èƒ½", dept: "-" }, "error", false);
        speak("èª­ã¿å–ã‚Œã¾ã›ã‚“ã§ã—ãŸã€‚ã‚‚ã†ä¸€åº¦ãŠé¡˜ã„ã—ã¾ã™ã€‚");

    } else {
        statusDiv.innerText = "ã€è­¦å‘Šã€‘æœªç™»éŒ²";
        statusDiv.style.color = "#dc3545"; statusDiv.style.backgroundColor = "#fff5f5";
        infoDisplay.innerHTML = `<table class="info-table"><tr><th>ãƒŠãƒ³ãƒãƒ¼</th><td class="res-plate-num">${plate}</td></tr><tr><th>æ°å</th><td>æœªç™»éŒ²</td></tr></table>`;
        addHistory(plate, dataArray[0], "alert", false);
        speak("æœªç™»éŒ²ã§ã™");
    }
}

function addHistory(num, data, type, isMulti) {
    const card = document.createElement('div');
    card.className = `card ${type}`;
    card.innerHTML = `<div><b>${num}</b> : ${data.name}${isMulti ? ' ä»–' : ''}</div><div style="font-size:11px; color:#999;">${new Date().toLocaleTimeString()}</div>`;
    historyItems.prepend(card);
    if (historyItems.children.length > 10) historyItems.lastChild.remove();
}

function speak(t) {
    window.speechSynthesis.cancel();
    setTimeout(() => {
        const s = new SpeechSynthesisUtterance(t);
        s.lang = 'ja-JP';
        s.rate = 1.0;
        window.speechSynthesis.speak(s);
    }, 100);
}

shutter.onclick = takePhoto;
window.onload = startCamera;
</script>
</body>
</html>
